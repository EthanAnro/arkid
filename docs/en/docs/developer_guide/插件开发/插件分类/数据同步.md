# Data synchronization

## User data synchronization
### Function introduction
User data synchronization is mainly to synchronize users and organizations between different systems through SCIM protocol. Server/Client mode is adopted. Server provides interfaces such as User and Group that conform to SCIM standard protocol, and Client obtains data by pulling the interface provided by Server through timing task</br>

The classic scenes are:

- Data synchronization between AD and ArkID
- Data synchronization between HR and ArkID
- Data synchronization between HR and AD

SCIM Protocol Reference

- [RFC7643 - SCIM: Core Schema](https://tools.ietf.org/html/rfc7643)
- [RFC7644 - SCIM: Protocol](https://tools.ietf.org/html/rfc7644)
- [RFC7642 - SCIM: Definitions, Overview, Concepts, and Requirements](https://tools.ietf.org/html/rfc7642)

### Realize the idea
First of all, the implementation of SCIM protocol on the Server side is in the code ** scim_server ** module.</br>
The three more important base classes are:

- **scim_server.views.view_template.ViewTemplate**
    - The subclass ** scim_server.views.users_view.UsersViewTemplate ** handles user-related additions, deletions, modifications, and queries.
    - Add, delete, modify and query related to subclass ** scim_server.views.groups_view.GroupsViewTemplate ** processing organization
- **scim_server.service.provider_adapter_template.ProviderAdapterTemplate**
- **scim_server.service.provider_base.ProviderBase**

The general process of SCIM Server handling SCIM requests is ** ViewTemplate ** to accept the request, convert the request parameters into objects and pass them to ** ProviderAdapterTemplate **.</br>
Val** ProviderAdapterTemplate ** idate the request parameters, further assemble the request object, and finally call ** ProviderBase ** the method to process the request object.</br>


** ScimSyncArkIDExtension ** Plug-in base class inheritance ** ProviderBase **, which is created ** UsersView ** and ** GroupsView ** inherited ** UsersViewTemplate ** ** GroupsViewTemplate ** respectively when the plug-in is loaded.</br>
And register the corresponding users _ URL and groups _ URL. So far, you only need to inherit the ScimSyncArkIDExtension plug-in base ** ProviderBase ** class and ** query_users ** override ** query_groups ** the methods inherited from, to implement the SCIM Server.</br>
Call the ** api.views.scim_sync.create_scim_sync ** interface processing function when creating the SCIM Server configuration, and return users _ URL and groups _ URL for the Client to pull data

The Client side creates a timing task through the Django _ celery _ beat, and first creates the configuration of the Client mode by calling ** api.views.scim_sync.create_scim_sync ** the interface processing function, and the configuration parameters need to specify the Scim Server. Used to pull data from the users _ URL and groups _ URL provided by the SCIM Server,</br>
If it is determined in the processing function that the configuration of the Client mode is to be created, a timed task is created, and the configuration of the Client mode is passed to celery asynchronous task: ** arkid.core.tasks.sync **, and this task will finally call the method in [sync](#arkid.core.extension.scim_sync.ScimSyncExtension.sync) the plug-in base class.</br>
[sync](#arkid.core.extension.scim_sync.ScimSyncExtension.sync) The method first calls [ get_groups_users ](#arkid.core.extension.scim_sync.ScimSyncExtension.get_groups_users) the method to obtain users and groups, and then calls [ sync_groups ](#arkid.core.extension.scim_sync.ScimSyncExtension.sync_groups) and [sync_users](#arkid.core.extension.scim_sync.ScimSyncExtension.sync_users) implements the synchronization logic. The specific plug-in needs to override these two methods to implement the synchronization logic on the Client side

### Abstract method
#### An abstract approach to the Server pattern
* [create_user](#arkid.core.extension.scim_sync.ScimSyncExtension.create_user)
* [create_group](#arkid.core.extension.scim_sync.ScimSyncExtension.create_group)
* [delete_user](#arkid.core.extension.scim_sync.ScimSyncExtension.delete_user)
* [delete_group](#arkid.core.extension.scim_sync.ScimSyncExtension.delete_group)
* [replace_user](#arkid.core.extension.scim_sync.ScimSyncExtension.replace_user)
* [replace_group](#arkid.core.extension.scim_sync.ScimSyncExtension.replace_group)
* [retrieve_user](#arkid.core.extension.scim_sync.ScimSyncExtension.retrieve_user)
* [retrieve_group](#arkid.core.extension.scim_sync.ScimSyncExtension.retrieve_group)
* [update_user](#arkid.core.extension.scim_sync.ScimSyncExtension.update_user)
* [update_group](#arkid.core.extension.scim_sync.ScimSyncExtension.update_group)
* [query_users](#arkid.core.extension.scim_sync.ScimSyncExtension.query_users)
* [query_groups](#arkid.core.extension.scim_sync.ScimSyncExtension.query_groups)
#### The abstract method of Client pattern
* [sync_groups](#arkid.core.extension.scim_sync.ScimSyncExtension.sync_groups)
* [sync_users](#arkid.core.extension.scim_sync.ScimSyncExtension.sync_users)
### Base class definition

::: arkid.core.extension.scim_sync.ScimSyncExtension
    
### Examples

::: extension_root.com_longgui_scim_sync_arkid.ScimSyncArkIDExtension
        
## Permission data synchronization