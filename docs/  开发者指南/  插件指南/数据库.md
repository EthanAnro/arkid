# 数据库

## 自定义数据表

插件可以拥有自己的数据表，只需要在根目录下创建models.py文件，使用Django ORM标准写法即可。

!!! info "提示"
    不用自己去跑 **makemigrations** ,ArkID在migrate前自动运行make migrations，但必须在根目录下手动创建 **migrations** 目录



## 扩展内核数据表

在arkid.core.models中定义的数据表，凡是继承自 ExtendModel 类的，都是默认可以进行直接扩展的model。

建议扩展的model类有：

* [arkid.core.models.Tenant](../../参考文档/数据表定义/#arkid.core.models.Tenant)
* [arkid.core.models.User](../../参考文档/数据表定义/#arkid.core.models.User)
* [arkid.core.models.UserGroup](../../参考文档/数据表定义/#arkid.core.models.UserGroup)
* [arkid.core.models.App](../../参考文档/数据表定义/#arkid.core.models.App)
* [arkid.core.models.AppGroup](../../参考文档/数据表定义/#arkid.core.models.AppGroup)

在插件中，定义一个model，其外键为以上这些类即可。为了方便此操作，在**arkid.core.expand**中已经定义好了这些抽象类，可以直接继承即可。

* [arkid.core.expand.TenantExpandAbstract](../../参考文档/数据表定义/#arkid.core.expand.TenantExpandAbstract)
* [arkid.core.expand.UserExpandAbstract](../../参考文档/数据表定义/#arkid.core.expand.UserExpandAbstract)
* [arkid.core.expand.UserGroupExpandAbstract](../../参考文档/数据表定义/#arkid.core.expand.UserGroupExpandAbstract)
* [arkid.core.expand.AppExpandAbstract](../../参考文档/数据表定义/#arkid.core.expand.AppExpandAbstract)
* [arkid.core.expand.AppGroupExpandAbstract](../../参考文档/数据表定义/#arkid.core.expand.AppGroupExpandAbstract)

定义好model后，需要调用 **[arkid.core.extension.Extension.register_extend_field]()** 注册，之后就可以直接进行查询，保存，删除操作

* **查询**: {model}.expand_objects
* **新建或修改**: {model}.save()
* **删除**: {model}.delete()

```py title='models.py'
from django.db import models
from arkid.core.models import UserExpandAbstract
from arkid.core.translation import gettext_default as _
from django.apps import AppConfig

class CaseApp(AppConfig):
    name = "com_longgui_case"
    
class CaseUser(UserExpandAbstract):
    class Meta:
        app_label = "com_longgui_case"
    
    nickname = models.CharField(verbose_name=_('nickname', '昵称'), max_length=128)
```

```py title='__init__.py'
from arkid.core import extension 
from arkid.core.translation import gettext_default as _
from arkid.core.models import User
from .models import CaseUser
from pydantic import Field

package = 'com.longgui.case'

UserSchema = extension.create_extension_schema(
    'UserSchema',
    package,
    fields=[
        ('username', str, Field()),
        ('nickname', str, Field()),
    ]
)

class CaseExtension(extension.Extension):
    def load(self):
        super().load()
        self.register_extend_field(CaseUser, 'nickname')
        self.register_api('/test/', 'POST', self.post_handler, auth=None, tenant_path=True)
        self.register_api('/test/', 'GET', self.get_handler, auth=None, tenant_path=True)

    def test_handler(self, request, data:UserSchema):
        tenant = request.tenant
        user = User()
        user.tenant = tenant
        user.username = data.username
        user.nickname = data.nickname
        user.save()

    def test_handler(self, request):
        tenant = request.tenant
        user = User.expand_objects.
        user.username = nickname
        user.tenant = tenant
        user.nickname = nickname
        user.save()
        return {
            'username':user.username,
            'nickname':user.nickname,
        }
```