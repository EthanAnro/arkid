## 前端界面

- 介绍怎样通过 openapi.json 的接口读取，生成前端页面。
- 说明 openapi.json 中与前端界面生成相关的配置规则。

!!! 提示
    在前端登录成功之后，openapi.json 接口会很早被调用，以便获取其中的内容来生成前端界面。接口返回的数据中包含 components、info、openapi、pages、paths、permissions、routers、translation 等字段信息。

### 路由（routers）

其主要声明前端路由信息，通过读取解析routers中内容，生成前端侧边栏等内容。其中page指向openapi.json接口返回数据pages中的某个页面配置。一共可以分为两种类别：

* 有Children的路由
* 无Children的路由

#### 字段声明

| 关键字 | 含义 | 类型 |
| --- | --- | --- |
| path | 路径，使用/字符进行叠加 | string |
| name | 侧边栏路由名称 | string |
| icon | 侧边栏路由图标，与前端配合 | string |
| hidden | 是否隐藏，如果为true，则不展示在前端侧边栏中 | boolean |
| page | 该路由需要渲染的页面，具体可以参考pages说明 | string |
| web | 是否为电脑端侧边栏，并含有顺序 | number |
| mobile | 是否为手机端底边栏，并含有顺序 | number |

#### children router

> 特别声明: 该类别的路由，最外层中的字段不包含page声明。

```json title='示例'
{
  "path": "mine",
  "name": "我的",
  "icon": "mine",
  "hidden": true,
  "children": [
    {
      "path": "profile",
      "name": "个人管理",
      "page": "mine_profile",
      "icon": "profile"
    },
    {
      "path": "logout",
      "name": "退出登录",
      "page": "mine_logout",
      "icon": "logout",
    },
  ]
}
```

#### no children router

```json title='示例'
{
  "path": "mine",
  "name": "我的",
  "icon": "mine",
  "hidden": true,
  "page": "mine",
}
```

### 页面（pages）

该模块的了解涉及到对前端界面的认知和从OpenAPI到前端界面的配置总体认知。

#### 初识页面

页面有哪些内容组成呢。下面的字段列表给出了我们所需的所有内容。

| 关键字 | 含义 | 功能 | 附加说明 |
| --- | --- | --- | --- |
| type | 页面类型 | 生成前端页面模板 | 具体参考下面的页面类型说明 |
| tag | 页面标识符 | 匹配唯一页面配置 | 不能重名，不使用.等特殊字符 |
| name | 页面名称 | - | - |
| init_action | 页面初始化操作 | 获取schema和数据 | 具体参考init_action详细说明 |
| init_data | 初始化数据 | 初始化后的赋值操作 | 默认从父级数据池开始查找 |
| global_action | 页面全局操作 | 生成全局按钮 | 具体参考global_action详细说明 |
| local_action | 页面局部操作 | 生成局部按钮 | 具体参考local_action详细说明 |
| node_action | 页面节点操作 | 生成树节点操作 | 仅存在于tree页面中，具体参考node_action详细说明 |
| select | 是否为可选页面 | 生成可选页面 | form页面中无需该字段 |
| pages | tabs/step多页面指向 | 生成tabs/step多页面 | 只存在于tabs/step页面中 |

!!! attention "重要提示"
    tag 不能重复使用，可以能使用 **.** 字符，不能使用 **[** 和 **]** 字符。

#### 页面类型

上述type字段目前只支持以下几种类型的页面。其中grid和list正在开发中，暂无效果。

| 类型 | 名称 | 附加说明 |
| --- | --- | :---: |
| table | 表格型页面 | ✔ |
| form | 表单型页面 | ✔ |
| tree | 树状性页面 | ✔ |
| tabs | 切换型页面 | ✔ |
| description | 描述型页面 | ✔ |
| cards | 卡片型页面 | ✔ |
| grid | 网格型页面 | ✘ |
| list | 列表型页面 | ✘ |
| step | 步骤型页面 | ✔ |

#### 操作类型

| 关键字 | 名称 | 详情 | 附加说明 |
| --- | --- | --- | :---: |
| direct | 直接型 | 常见于删除或树节点点击获取Children等操作 | ✔ |
| open | 弹框型 | 打开对话框，展示新的一个类型页面，常见于创建或编辑等操作 |  ✔ |
| cascade | 级联型 | 常见于树状型页面的级联页面使用，当点击某个节点时, 出现与之并列的数据展示页面 |  ✔ |
| import | 导入型 | 导入文件或数据时使用 | ✘ |
| export | 导出型 | 导出文件或数据时使用，全导出或部分导出 | ✘ |
| next | 步骤型 | 点击继续下一步操作，根据情况自动添加上一步按钮 | ✔ |

!!! 提示
    具体操作类型的使用见下方。

#### 操作配置

操作的主要功能为匹配schema和增删改查数据。

| 关键字 | 含义 | 功能 |
| --- | --- | --- |
| tag | 操作标签 | 可用于前端操作名称 |
| path | API接口 | 用于匹配schema和获取数据 |
| method | API接口方法 | 同上 |
| type | 操作类型（见上方具体说明）| 方便识别操作 |
| page | 页面tag | 当且仅当类型为open时，有时需指向要打开页面的唯一标识 |
| name | 操作名称 | 前端页面按钮名，node_action无需包含该内容 |
| icon | 图标 | 可选，目前暂未支持 |
| close | 关闭条件 | 待更新优化 |
| open | 打开条件 | 待更新优化 |


!!! info "温馨提示"
    具体可以参考后端生成或django-ninja等框架说明

#### init_action

init_action主要完成页面组成的初始化以及数据的获取。

在声明该部分的内容时，无需声明操作的类型。

```json title='示例'
{
  "init_action": {
    "path": "xxx",
    "method": "get",
  }
}
```

#### global_action

global_action主要完成页面全局按钮的生成，以及对应其操作的初始化。

在声明该部分的内容时，应说明每一个操作的类型。

```json title='示例'
{
  "global_action": {
    "create": {
      "name": "新建",
      "path": "",
      "method": "post",
      "type": "open",
      "page": "",
    },
    "import": {
      "name": "导入",
      "path": "",
      "method": "post",
      "type": "import",
    },
    "export": {
      "name": "导出",
      "path": "",
      "method": "post",
      "type": "direct",
    },
  }
}
```

!!! 提示
    由于创建时，只需要post方法的接口，所以无需再声明page字段内容。此时在前端的页面生成逻辑中，将会自动解析和处理。

#### local_action

local_action主要完成页面全局按钮的生成，以及对应其操作的初始化。

在声明该部分的内容时，应说明每一个操作的类型。

```json title='示例'
{
  "local_action": {
    "edit": {
      "name": "编辑",
      "type": "open",
      "page": "edit_page",
    },
    "delete": {
      "name": "删除",
      "type": "direct",
      "path": "",
      "method": "",
    }
  }
}
```

#### node_action

node_action主要完成页面树节点的生成。功能主要为获取子节点和级联页面的数据。

在声明该部分的内容时，应说明操作的类型。

!!! 提示
    树页面和级联页面（如果存在的话），在执行完该页面的init_action之后，如果有树节点数据，会默认点击第一个节点，自动执行一次该node_action中的所有操作。

```json title='示例'
{
  "node_action": [
    {
      "path": "",
      "method": "",
      "type": "direct",
    },
    {
      "type": "cascade",
      "page": "",
    },
  ]
}
```

#### prop_action

!!! attention "注意"
    该模块的操作并不是页面配置中的某个字段。item_action或suffix_action为某个页面元素的直接操作。该类型的操作均应当声明到schmea的描述之中，在生成页面的过程中直接赋予某个页面属性所独有。

| 关键字 | 含义 | 功能描述 |
| --- | --- | --- |
| item_action | 某个元素的直接操作 | switch(change)或input(blur)或select(options)时将会执行该操作 |
| suffix_action | 某个元素的后缀操作 | 比如发送验证码等操作 |
| option_action | 下拉选项操作 | 下拉动态数据的获取 |

```json title='示例1  -  item_action'
{
  "phone_number": {
    "title": "主题",
    "type": "string",
    "item_action": {
      "path": "",
      "method": "",
    }
  }
}
```

```json title='示例2  -  suffix_action'
{
  "phone_number": {
    "title": "手机号码",
    "type": "string",
    "suffix_action": {
      "path": "",
      "method": "post",
      "delay": 60,
    }
  }
}
```

#### 解析操作配置

读了上述的文档之后，对页面操作配置有了一定的了解，那么，前端如何解析操作呢？

使用操作中的path和method在openapi.json接口返回的paths中找到对应的schema指向。如果method为get的话，则读取其中的responses信息中的schema指向；否则，读取requestBody信息中的schema指向。

通过schema的指向，再继续寻找components.schema中对应的描述信息。再继续通过每一项不同的属性声明，来生成前端不同的组件模板，继而组成一个完整的页面。

描述页面中的类型说明：

| 关键字 | 类型 | 附加说明 |
| --- | --- | --- |
| string | 字符串 | input |
| boolean | 布尔值 | switch |
| integer | 整型 | input-number |
| array | 数组 | select |
| object | 对象 | form-object |
| format | 指定类型 | 根据不同format值生成，比如date/autocomplete/dynamic等 |

### 页面配置

#### 表格型页面（table）

!!! 提示
    某些页面中存在filter过滤器，该部分内容是通过paths中声明的parameters的内容解析得来。不包含in=path的参数，也同时排除了page和page_size两个分页器参数。

```json title='示例'
{
  "type": "table",
  "tag": "",
  "name": "用户列表",
  "modal": false,
  "init_action": {
    "path": "",
    "method": "",
  },
  "global_action": {
    "create": {
      "name": "新建",
      "type": "open",
      "path": "",
      "method": "post",
    },
    "import": {
      "name": "导入",
      "type": "import",
      "path": "",
      "method": "post",
    }
  },
  "local_action": {
    "edit": {
      "name": "编辑",
      "type": "open",
      "page": "",
    },
    "set_password": {
      "name": "密码设置",
      "type": "open",
      "page": "",
    },
    "delete": {
      "name": "删除",
      "type": "direct",
      "path": "",
      "method": "delete"
    }
  }
}
```

#### 表单型页面（form）

!!! 提示
    该类型页面没有local_action声明。

```json title='示例'
{
  "type": "form",
  "tag": "",
  "name": "重置密码",
  "modal": true,
  "init_action": {
    "path": "",
    "method": "get",
  },
  "global_action": {
    "edit": {
      "name": "确认",
      "path": "",
      "method": "post",
    },
  },
}
```

#### 树状页面（tree）

```json title='示例'
{
  "type": "tree",
  "tag": "",
  "name": "用户分组",
  "init_action": {
    "path": "",
    "method": "get",
  },
  "node_action": [
    {
      "path": "",
      "method": "get",
      "type": "direct"
    },
    {
      "page": "",
      "type": "cascade",
    }
  ],
  "global_action": {
    "create": {
      "name": "新建",
      "type": "open",
      "path": "",
      "method": "post",
    },
    "import": {
      "name": "导入",
      "type": "import",
      "path": "",
      "method": "post",
    }
  },
  "local_action": {
    "edit": {
      "name": "编辑",
      "type": "open",
      "page": "",
    },
    "delete": {
      "name": "删除",
      "type": "direct",
      "path": "",
      "method": "delete"
    }
  },
}
```

#### 切换型页面（tabs）

```json title='示例'
{
  "type": "tabs",
  "tag": "",
  "name": "插件管理",
  "pages": [ "", "", "" ],
}
```

#### 卡片型页面（cards）

!!! 提示
    该类型的页面的init_action的操作返回的数据可能具有自定义的特点，所以在某些时候需要与前端配合使用。

```json title='示例'
{
  "type": "cards",
  "tag": "",
  "name": "应用集",
  "init_action": {
    "path": "",
    "method": "get",
  },
}
```

#### 描述型页面（description）

```json title='示例'
{
  "type": "description",
  "tag": "",
  "name": "个人资料",
  "init_action": {
    "path": "",
    "method": "get",
  },
}
```

#### 网格型页面（grid）

!!! attention 注意
    开发测试中，暂无效果。

#### 列表型页面（list）

!!! attention 注意
    开发测试中，暂无效果。


## 后端配置说明

根据上述配置信息结构说明，我们需要在后端接口（/api/v1/openapi.json）中对应生成页面配置数据以供前端解析，以下是基础的代码步骤：

1. 创建一个page

``` python

from arkid.core import pages

user_list_tag = 'user_list'
user_list_name = '用户列表'


page = pages.FrontPage(
    tag=user_list_tag,
    name=user_list_name,
    page_type=pages.FrontPageType.TABLE_PAGE,
    init_action=pages.FrontAction(
        path='/api/v1/tenant/{tenant_id}/users/',
        method=pages.FrontActionMethod.GET
    )
)

```

2. 为page添加action
``` python
...

page.add_local_action(
    [
        pages.FrontAction(
            name=_("删除"),
            method=pages.FrontActionMethod.DELETE,
            path="/api/v1/tenant/{tenant_id}/users/{id}/",
            icon="icon-delete",
            action_type=pages.FrontActionType.DIRECT_ACTION
        )
    ]
)

...

```

3. 将page注册到全局
``` python

pages.register_front_pages(page)

```

4. 写入路由信息
``` python
from arkid.core import routers

user_list_router = routers.FrontRouter(
    path="user_list",
    name='用户管理',
    icon='user',
    page=page,
)

router = routers.FrontRouter(
    path='user',
    name='用户管理',
    icon='user',
    children=[
        user_list_router,
    ],
)

```

5. 最后在访问/api/v1/openapi.json接口时可得到数据为：
``` json
{
  ...
  "routers": [
      {
          "path": "user",
          "name": "用户管理",
          "icon": "user",
          "children": [
              {
                  "path": "user_list",
                  "name": "用户管理",
                  "icon": "user",
                  "page": "user_list"
              }
          ]
      }
  ],
  "pages": [
      {
          "tag": "user_list",
          "name": "用户列表",
          "type": "table",
          "init": {
              "tag": "16058e11df284ae1a58fd1220a85e501",
              "path": "/api/v1/tenant/{tenant_id}/users/",
              "method": "get"
          },
          "local": [
              {
                  "tag": "9181f711ffcb4ac5b5a793e043468595",
                  "name": "删除",
                  "path": "/api/v1/tenant/{tenant_id}/users/{id}/",
                  "method": "delete",
                  "icon": "icon-delete",
                  "type": "direct"
              }
          ],
      },
  ]
}
...
```