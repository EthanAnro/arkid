## 从OpenAPI到前端界面

### 目标

> 旨在通过 OpenAPI 配置描述, 进一步在前端进行读取解析的方式, 直接生成前端项目页面。

根据上述的目标说明, 该文档也将从 OpenAPI 接口返回的 JSON 数据入手, 一步步分析每一项的配置对应到页面中的内容。

### 配置分析

#### 初识接口
    /api/v1/openapi.json

上述接口主要返回 components/info/pages/paths/routers/translation 等数据信息。当前文档主要分析
其中的 routers 以及 pages 内容, 也就是主要分析怎样通过这些信息在前端生成一个个页面的。

#### 路由配置 - Routers

> Router 的类型有两种

- 类型 1: 无Children的路由

```
{
  icon: "icon-contacts",
  name: "通讯录",
  path: "contacts",
  page: "contacts",
}

【字段说明】
  1. icon -- 指明前端路由图标, 默认为dashboard图标
  2. name -- 路由名称, 展示在前端侧边栏的名称
  3. path -- 转化为前端路由访问路径(具有叠加效果)
  4. page -- 指向/api/v1/openapi.json接口中pages配置中的一项, 根据tag进行匹配

【使用规则】
  1. icon -- 需要与前端配合
  2. name -- 全局应当具有唯一性
  3. path -- 字符串, 应避免使用某些特殊字符
  4. page -- 字符串类型
```

- 类型 2: 有Children的路由

```
{
  icon: "icon-settings",
  name: "用户设置",
  path: "userSettings",
  children: [
    {
      icon: "icon-desktop",
      name: "桌面设置",
      path: "desktop",
      page: "desktop_settings",
    },
    {
      icon: "icon-contacts",
      name: "通讯录设置",
      path: "contacts",
      page: "contacts_settings",
    }
  ]
}

【附加说明】
  拥有Child的路由, 在每一级的父级路由上都不应再存在page字段说明, 否则将会忽略
```

### 页面配置 - Pages

#### 页面类型

1. 表格型页面 （table）
1. 表单型页面 （form）
1. 描述型页面 （description）
1. 树状型页面 （tree）
1. 切换型页面 （tabs）
1. 列表型页面 （list）
1. 卡片型页面 （cards）
1. 网格型页面 （grid）

#### 操作类型

1. direct 直接型
> 常见于删除/树节点点击获取Children等操作。
1. open 打开页面型
> 常见于创建/编辑等打开弹出框的操作。
1. import 导入数据型
> 为导入某个数据表进行的操作。
1. url 内外链接型
> 为跳转至某个页面进行的操作。
1. password 密码型
> 支持修改密码或添加密码而进行的操作。
1. cascade 级联型
> 常见于树状型页面的级联页面使用。当点击某个节点时, 应出现并列的数据展示页面。

#### 页面配置说明
```
主要字段说明:
  tag 页面标识符, 进行唯一匹配使用
  name 页面或操作描述信息
  type 页面或操作类型, 见上述说明
  init_action 页面初始化操作（获取主页面schema和data）【格式为action】
  global_action 页面全局操作【格式为key: action】
  local_action 页面局部操作【格式为key: action】


其他字段说明（可能只有部分页面需要添加）: 
  node_action 节点操作【格式为actions】
  select 是否可以进行选择
  pages tabs类型页面指向多个页面
```

#### 表格型页面

该模块主要通过配置的举例, 说明表格型页面是怎样配置的。

1. 主页面配置

```
{
  tag: "user_list",
  name: "用户列表",
  type: "table",
  init_action: {
    path: "/api/v1/tenant/{tenant_id}/users/",
    method: "get",
  },
  global_action: { // 页面全局操作
    create: {
      icon: "icon-create",
      name: "创建",
      path: "/api/v1/tenant/{tenant_id}/users/",
      method: "post",
      type: "open",
    },
    import: {
      icon: "icon-import",
      name: "导入",
      path: "/api/v1/tenant/{tenant_id}/users/import/",
      method: "post",
      type: "import",
    },
    export: {
      icon: "icon-export",
      name: "导出",
      path: "/api/v1/tenant/{tenant_id}/users/export/",
      method: "post",
      type: "direct",
    }
  },
  local_action: {
    edit: {
      icon: "icon-edit",
      name: "编辑",
      page: "user_list_edit",
      action_type: "open",
    },
    delete: {
      icon: "icon-delete",
      name: "删除",
      path: "/api/v1/tenant/{tenant_id}/users/",
      method: "delete",
      action_type: "direct",
    }
  }
}
```
2. 弹出框页面配置

```
{
  tag: "user_list_edit",
  name: "编辑用户信息",
  type: "form",
  init_action: {
    path: "/api/v1/tenant/{tenant_id}/users/{id}/",
    method: "get",
  },
  global_action: {
    confirm: {
      icon: "icon-confirm",
      name: "确认",
      path: "/api/v1/tenant/{tenant_id}/users/{id}/",
      method: "post",
      type: "direct",
    }
  }
}
```

#### 表单型页面

该模块举例说明表单型页面应该怎样配置。

```
{
  tag: "user_list_edit",
  name: "编辑用户信息",
  type: "form",
  init_action: {
    path: "/api/v1/tenant/{tenant_id}/users/{id}/",
    method: "get",
  },
  global_action: {
    confirm: {
      icon: "icon-confirm",
      name: "确认",
      path: "/api/v1/tenant/{tenant_id}/users/{id}/",
      method: "post",
      type: "direct",
    }
  }
}
```

#### 树状型页面

树状型页面配置举例说明。

```
{
  tag: 'user_group',
  name: '用户分组',
  type: 'tree',
  init_action: {
    path: '',
    method: '',
  },
  node_action: [
    {
      path: '',
      method: '',
      type: 'direct',
    },
    {
      page: '',
      type: 'cascade',
    }
  ],
  global_action: {
    create: {
      name: '创建',
      icon: 'icon-create',
      page: '',
      type: 'open',
    },
  },
  local_action: {
    edit: {
      name: '编辑',
      icon: 'icon-edit',
      page: '',
      type: 'open',
    },
    delete: {
      name: '删除',
      icon: 'icon-delete',
      path: '',
      method: '',
      type: 'direct',
    } 
  }
}
```

#### 切换型页面

切换型页面配置举例说明。

```
{
  tag: 'grant_manage',
  name: '管理页面',
  type: 'tabs',
  pages: [ 'aaa', 'bbb', 'ccc' ],
}
```

#### 列表型页面

列表型页面配置举例说明。

```
{
  tag: 'aaa',
  name: '列表数据',
  type: 'list',
  init_action: {
    path: '',
    method: '',
  }
}
```

#### 卡片型页面

卡片型页面配置举例说明。

```
{
  tag: 'app_market',
  name: '应用市集',
  type: 'cards',
  init_action: {
    path: '',
    method: '',
  }
}
```

#### 网格型页面

网格型页面配置举例说明。

```
{
  tag: 'desktop',
  name: '我的桌面',
  type: 'grid',
  pages: [
    {
      tag: 'aaa',
      width: 100,
      height: 200,
    },
    {
      tag: 'bbb',
      width: 200,
      height: 600,
    }
  ]
}
```

#### 描述型页面

描述型页面配置举例说明。

```
{
  tag: "user_profile",
  name: "用户个人信息",
  type: "description",
  init_action: {
    path: "/api/v1/user/",
    method: "get",
  }
}
```

### 读取步骤

通过上述配置信息的了解, 相信正在阅读文档的你已经对我们的工作有了一定的了解。接下来, 将带领你进一步再了解一下从 OpenAPI 的读取到前端页面的生成过程。

1. 获取接口`/api/v1/openapi.json`返回的信息
1. 读取`routers`信息, 生成侧边栏, 切换侧边栏时, 通过 page 字段匹配`pages`中的内容
1. 通过`pages`选项, 读取 init/global/local 等信息, 根据里面的`path`和`method`去`paths`中匹配相应内容
1. 在`paths`中获取到相应的`operationId`/`parameters`/`responses`/`requestBody`等信息, 继续匹配`components`中的相应内容
1. 根据`components`中的描述生成页面结构, 并根据配置中的路径获取数据和完成增删改查等操作


## **后端配置说明**

根据上述配置信息结构说明，我们需要在后端接口（/api/v1/openapi.json）中对应生成页面配置数据以供前端解析，以下是基础的代码步骤：

1. 创建一个page

``` python

from arkid.core import pages

user_list_tag = 'user_list'
user_list_name = '用户列表'


page = pages.FrontPage(
    tag=user_list_tag,
    name=user_list_name,
    page_type=pages.FrontPageType.TABLE_PAGE,
    init_action=pages.FrontAction(
        path='/api/v1/tenant/{tenant_id}/users/',
        method=pages.FrontActionMethod.GET
    )
)

```

2. 为page添加action
``` python
...

page.add_local_action(
    [
        pages.FrontAction(
            name=_("删除"),
            method=pages.FrontActionMethod.DELETE,
            path="/api/v1/tenant/{tenant_id}/users/{id}/",
            icon="icon-delete",
            action_type=pages.FrontActionType.DIRECT_ACTION
        )
    ]
)

...

```

3. 将page注册到全局
``` python

pages.register_front_pages(page)

```

4. 写入路由信息
``` python
from arkid.core import routers

user_list_router = routers.FrontRouter(
    path="user_list",
    name='用户管理',
    icon='user',
    page=page,
)

router = routers.FrontRouter(
    path='user',
    name='用户管理',
    icon='user',
    children=[
        user_list_router,
    ],
)

```

5. 最后在访问/api/v1/openapi.json接口时可得到数据为：
``` json
{
  ...
  "routers": [
      {
          "path": "user",
          "name": "用户管理",
          "icon": "user",
          "children": [
              {
                  "path": "user_list",
                  "name": "用户管理",
                  "icon": "user",
                  "page": "user_list"
              }
          ]
      }
  ],
  "pages": [
      {
          "tag": "user_list",
          "name": "用户列表",
          "type": "table",
          "init": {
              "tag": "16058e11df284ae1a58fd1220a85e501",
              "path": "/api/v1/tenant/{tenant_id}/users/",
              "method": "get"
          },
          "local": [
              {
                  "tag": "9181f711ffcb4ac5b5a793e043468595",
                  "name": "删除",
                  "path": "/api/v1/tenant/{tenant_id}/users/{id}/",
                  "method": "delete",
                  "icon": "icon-delete",
                  "type": "direct"
              }
          ],
      },
  ]
}
...
```